pipeline {
    agent any

    environment {
        REGISTRY  = 'suarim'
        IMAGE     = "${REGISTRY}/jenksdocks"
        TAG       = "v${BUILD_NUMBER}"
        CONTAINER = 'jenksdocks-app'
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build') {
            steps {
                sh """
                  docker build -t ${IMAGE}:${TAG} .
                """
            }
        }

        stage('Push') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker_pass',
                        usernameVariable: 'DOCKER_USERNAME',
                        passwordVariable: 'DOCKER_PASSWORD'
                    )
                ]) {
                    sh """
                      echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                      docker push ${IMAGE}:${TAG}
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                withCredentials([file(credentialsId: 'jenks', variable: 'ENV_FILE')]) {
                    sh """
                      docker rm -f ${CONTAINER} 2>/dev/null || true
                      docker run -it --name ${CONTAINER} \
                        --restart unless-stopped \
                        --env-file "${ENV_FILE}" \
                        -p 10000:11000 \
                        ${IMAGE}:${TAG}
                    """
                }
            }
        }
    }

    post {
        always { cleanWs() }
    }
}
